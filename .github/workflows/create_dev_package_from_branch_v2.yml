name: Create a package from branch V2

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        type: string

jobs:
  docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch }}
          path: ${{ inputs.branch }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Run Ruff
        run: ruff check --output-format=github .

      - name: Sanitize branch name
        id: sanitize
        run: |
          SAFE=$(echo "${{ inputs.branch }}" | tr '/_' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-50)
          echo "SANITIZED_BRANCH=$SAFE" >> $GITHUB_ENV

      - name: Set image tags
        run: |
          if [ -n "${{ inputs.branch }}" ]; then
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            BRANCH_NAME=$(echo "${{ inputs.branch }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
            echo "TAG_VERSION=dev-${BRANCH_NAME}-${TIMESTAMP}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG_VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "TAG_VERSION=latest" >> $GITHUB_ENV
          else
            echo "TAG_VERSION=latest" >> $GITHUB_ENV
          fi

      - name: Log into GHCR
        uses: docker/login-action@v2
        with: 
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: ${{ github.event_name == 'workflow_dispatch' && format('{0}/applications/nazAPIi', inputs.branch) || './applications/nazAPIi' }}
          file: ${{ github.event_name == 'workflow_dispatch' && format('{0}/applications/nazAPIi/docker/Dockerfile', inputs.branch) || './applications/nazAPIi/docker/Dockerfile' }}
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ env.TAG_VERSION }}
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:cache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:cache,mode=max
