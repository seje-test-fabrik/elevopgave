name: Build and push docker image with cache

on: 
    push:
        branches:
            - main
    workflow_call:
      

jobs: 
    docker-build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout source
              uses: actions/checkout@v5
            
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log into GHCR
              uses: docker/login-action@v2
              with: 
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
                  
            - name: Get commit SHA
              id: sha
              run: |
                COMMIT=$(git rev-parse --short HEAD)
                echo "COMMIT_SHA=$COMMIT" >> $GITHUB_ENV

            - name: Build and push 
              uses: docker/build-push-action@v4
              with: 
                context: ./applications/nazAPIi
                file: ./applications/nazAPIi/docker/Dockerfile 
                push: true
                tags: |
                  ghcr.io/${{ github.repository }}:${{ env.COMMIT_SHA }}
                  ghcr.io/${{ github.repository }}:latest
                cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:cache
                cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:cache,mode=max